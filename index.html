<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Planejador Din√¢mico - Multi Visualiza√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .time-slot {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
            position: relative;
        }

        .time-slot:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .time-slot.editing {
            border: 2px solid #3b82f6;
            background: #eff6ff;
        }

        .edit-controls {
            position: absolute;
            top: 2px;
            right: 2px;
            display: none;
            gap: 4px;
        }

        .time-slot:hover .edit-controls {
            display: flex;
        }

        .fixed-class { border-left-color: #ef4444; background: linear-gradient(135deg, #fef2f2, #fee2e2); }
        .coordination { border-left-color: #3b82f6; background: linear-gradient(135deg, #eff6ff, #dbeafe); }
        .personal-project { border-left-color: #8b5cf6; background: linear-gradient(135deg, #f5f3ff, #ede9fe); }
        .university { border-left-color: #10b981; background: linear-gradient(135deg, #ecfdf5, #d1fae5); }
        .self-care { border-left-color: #f59e0b; background: linear-gradient(135deg, #fffbeb, #fef3c7); }
        .free-time { border-left-color: #ec4899; background: linear-gradient(135deg, #fdf2f8, #fce7f3); }

        .view-day { display: block; }
        .view-week { display: grid; grid-template-columns: repeat(7, 1fr); }
        .view-month { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }

        .month-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            padding: 4px;
            background: white;
        }

        .month-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }

        .month-day.today {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .month-task {
            font-size: 10px;
            padding: 1px 4px;
            margin: 1px 0;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .floating-tips {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .tip-card {
            animation: slideIn 0.5s ease-out;
        }

        .edit-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg border-b-4 border-indigo-500">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Meu Planejador Din√¢mico</h1>
                    <p class="text-gray-600 mt-1">Organizando o caos com intelig√™ncia ‚ú®</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="startNewWeeklyRoutine()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                        üöÄ START
                    </button>
                    <button onclick="showTips()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üí° Dicas
                    </button>
                    <button onclick="exportSchedule()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üì± Exportar
                    </button>
                    <button onclick="resetWeeklyProgress()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üîÑ Nova Semana
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Controls -->
    <div class="bg-white shadow-md border-b">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- View Toggle -->
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button onclick="setView('day')" id="dayViewBtn" class="px-4 py-2 rounded-md font-medium transition-colors bg-indigo-500 text-white">
                        üìÖ Dia
                    </button>
                    <button onclick="setView('week')" id="weekViewBtn" class="px-4 py-2 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-900">
                        üìä Semana
                    </button>
                    <button onclick="setView('month')" id="monthViewBtn" class="px-4 py-2 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-900">
                        üìÜ M√™s
                    </button>
                </div>

                <!-- Date Navigation -->
                <div class="flex items-center gap-4">
                    <button onclick="navigateDate(-1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg font-medium transition-colors">
                        ‚Üê Anterior
                    </button>
                    <div class="text-center">
                        <div class="text-lg font-semibold text-gray-900" id="currentDateDisplay">
                            Hoje
                        </div>
                        <div class="text-xs text-gray-500" id="currentWeekDisplay">
                            Semana atual
                        </div>
                    </div>
                    <button onclick="navigateDate(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg font-medium transition-colors">
                        Pr√≥ximo ‚Üí
                    </button>
                    <button onclick="goToToday()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg font-medium transition-colors">
                        Hoje
                    </button>
                    <button onclick="showWeekHistory()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg font-medium transition-colors">
                        üìö Hist√≥rico
                    </button>
                </div>

                <!-- Quick Add -->
                <button onclick="quickAddTask()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    ‚ûï Adicionar
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Tips -->
    <div id="floatingTips" class="floating-tips hidden">
        <div class="tip-card bg-white rounded-lg shadow-xl p-4 mb-3 border-l-4 border-indigo-500">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-semibold text-gray-900">üí° Dica do Dia</h3>
                    <p id="dailyTip" class="text-sm text-gray-600 mt-1"></p>
                </div>
                <button onclick="hideTips()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-6">
        <!-- Controls -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Atual:</label>
                    <input type="date" id="currentDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="updateCurrentDate()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Foco Atual:</label>
                    <select id="weeklyFocus" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="regenerateSchedule()">
                        <option value="certificates">Certificados</option>
                        <option value="mural">Atualiza√ß√£o do Mural</option>
                        <option value="server">Limpeza do Servidor</option>
                        <option value="monitors">Rotina dos Monitores</option>
                        <option value="content">Novos Conte√∫dos</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Energia:</label>
                    <select id="energyLevel" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="regenerateSchedule()">
                        <option value="high">Alta Energia üî•</option>
                        <option value="medium">Energia Moderada ‚ö°</option>
                        <option value="low">Energia Baixa üå±</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Legenda de Atividades</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-red-500 rounded"></div>
                    <span class="text-sm">Aulas</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                    <span class="text-sm">Coordena√ß√£o</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-purple-500 rounded"></div>
                    <span class="text-sm">Projeto S√°fico</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                    <span class="text-sm">Faculdade</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                    <span class="text-sm">Autocuidado</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-pink-500 rounded"></div>
                    <span class="text-sm">Tempo Livre</span>
                </div>
            </div>
        </div>

        <!-- Main Schedule Container -->
        <div id="scheduleContainer">
            <!-- Day View -->
            <div id="dayView" class="view-container">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div id="dayHeader" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-6">
                        <h3 class="font-bold text-2xl" id="dayTitle">Hoje</h3>
                        <p class="text-indigo-100 mt-1" id="daySubtitle">Organize seu dia!</p>
                    </div>
                    <div class="p-6">
                        <div id="daySchedule" class="space-y-3">
                            <!-- Day tasks will be populated here -->
                        </div>
                        <button onclick="addNewTask()" class="w-full mt-4 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 py-3 rounded-lg font-medium transition-colors border-2 border-dashed border-indigo-300">
                            ‚ûï Adicionar Nova Tarefa
                        </button>
                    </div>
                </div>
            </div>

            <!-- Week View -->
            <div id="weekView" class="view-container hidden">
                <div class="grid grid-cols-1 lg:grid-cols-7 gap-4" id="weekSchedule">
                    <!-- Week days will be populated here -->
                </div>
            </div>

            <!-- Month View -->
            <div id="monthView" class="view-container hidden">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4">
                        <h3 class="font-bold text-xl" id="monthTitle">M√™s</h3>
                        <div class="grid grid-cols-7 gap-2 mt-4 text-center text-sm">
                            <div class="font-medium">Dom</div>
                            <div class="font-medium">Seg</div>
                            <div class="font-medium">Ter</div>
                            <div class="font-medium">Qua</div>
                            <div class="font-medium">Qui</div>
                            <div class="font-medium">Sex</div>
                            <div class="font-medium">S√°b</div>
                        </div>
                    </div>
                    <div id="monthCalendar" class="view-month p-4">
                        <!-- Month calendar will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Chat Assistant -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                ü§ñ Assistente Inteligente
                <span class="text-sm font-normal text-gray-500">(Digite sua demanda e eu replanejo sua agenda!)</span>
            </h3>

            <!-- Chat Messages -->
            <div id="chatMessages" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto mb-4 space-y-3">
                <div class="flex items-start gap-3">
                    <div class="bg-indigo-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">AI</div>
                    <div class="bg-white rounded-lg p-3 shadow-sm max-w-md">
                        <p class="text-sm">Oi! Sou seu assistente de agenda. Me conte sobre qualquer nova demanda e eu vou reorganizar sua agenda automaticamente! üòä</p>
                        <p class="text-xs text-gray-500 mt-1">Exemplos: "Preciso preparar uma apresenta√ß√£o de 3 horas" ou "Surgiu uma reuni√£o quinta √†s 15h"</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="flex gap-3">
                <input
                    type="text"
                    id="chatInput"
                    placeholder="Ex: Preciso preparar palestra de 2h para sexta-feira..."
                    class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    onkeypress="handleChatKeyPress(event)"
                >
                <button
                    onclick="sendChatMessage()"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                >
                    Enviar
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="quickDemand('reuniao')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-sm transition-colors">
                    üìÖ Nova Reuni√£o
                </button>
                <button onclick="quickDemand('apresentacao')" class="bg-purple-100 hover:bg-purple-200 text-purple-800 px-3 py-1 rounded-full text-sm transition-colors">
                    üé§ Preparar Apresenta√ß√£o
                </button>
                <button onclick="quickDemand('projeto')" class="bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm transition-colors">
                    üöÄ Novo Projeto
                </button>
                <button onclick="quickDemand('emergencia')" class="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-full text-sm transition-colors">
                    üö® Demanda Urgente
                </button>
            </div>
        </div>
    </div>

    <!-- Week History Modal -->
    <div id="weekHistoryModal" class="edit-modal hidden">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-96 overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">üìö Hist√≥rico de Semanas</h3>
                <button onclick="closeWeekHistory()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>

            <div class="mb-4">
                <div class="flex gap-2 mb-3">
                    <button onclick="createNewWeek()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ‚ûï Nova Semana
                    </button>
                    <button onclick="duplicateCurrentWeek()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üìã Duplicar Atual
                    </button>
                    <button onclick="exportAllWeeks()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üì± Exportar Tudo
                    </button>
                </div>
            </div>

            <div id="weekHistoryList" class="space-y-3 max-h-64 overflow-y-auto">
                <!-- Week history items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="edit-modal hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">‚úèÔ∏è Editar Tarefa</h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>

            <form id="editForm" onsubmit="saveTaskEdit(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Tarefa:</label>
                        <input type="text" id="editTaskName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" required>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hora In√≠cio:</label>
                            <input type="time" id="editStartTime" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hora Fim:</label>
                            <input type="time" id="editEndTime" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data:</label>
                        <input type="date" id="editTaskDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria:</label>
                        <select id="editTaskType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500">
                            <option value="fixed-class">Aulas (Fixo)</option>
                            <option value="coordination">Coordena√ß√£o</option>
                            <option value="personal-project">Projeto S√°fico</option>
                            <option value="university">Faculdade</option>
                            <option value="self-care">Autocuidado</option>
                            <option value="free-time">Tempo Livre</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o (opcional):</label>
                        <textarea id="editTaskDescription" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-lg font-medium transition-colors">
                        üíæ Salvar
                    </button>
                    <button type="button" onclick="deleteTask()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        üóëÔ∏è Excluir
                    </button>
                    <button type="button" onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentView = 'day';
        let currentDate = new Date();
        let allTasks = [];
        let editingTask = null;
        let chatHistory = [];
        let weeklyHistory = {}; // Stores all weeks: { "2024-W01": { tasks: [], settings: {}, created: "date" } }
        let currentWeekKey = '';

        // Smart schedule generator based on focus and energy
        const scheduleTemplates = {
            // Weekly focus templates
            certificates: {
                name: 'Certificados',
                priority: 'coordination',
                mainTasks: ['Verificar informa√ß√µes', 'Conferir trabalhos', 'Gerar certificados', 'Organizar documentos']
            },
            mural: {
                name: 'Atualiza√ß√£o do Mural',
                priority: 'coordination',
                mainTasks: ['Coletar trabalhos alunos', 'Organizar por turma', 'Atualizar mural', 'Fotografar resultados']
            },
            server: {
                name: 'Limpeza do Servidor',
                priority: 'coordination',
                mainTasks: ['Backup arquivos', 'Organizar pastas', 'Deletar arquivos antigos', 'Otimizar espa√ßo']
            },
            monitors: {
                name: 'Rotina dos Monitores',
                priority: 'coordination',
                mainTasks: ['Definir tarefas monitores', 'Acompanhar atividades', 'Feedback semanal', 'Planejamento pr√≥xima semana']
            },
            content: {
                name: 'Novos Conte√∫dos',
                priority: 'coordination',
                mainTasks: ['Pesquisar refer√™ncias', 'Criar material', 'Testar conte√∫do', 'Implementar nas aulas']
            }
        };

        // Energy level adjustments
        const energyAdjustments = {
            high: {
                name: 'Alta Energia üî•',
                academyFreq: 5, // 5x por semana
                projectTime: 3, // 3h por dia projeto s√°fico
                studyIntensity: 'high',
                socialTime: 'active'
            },
            medium: {
                name: 'Energia Moderada ‚ö°',
                academyFreq: 3, // 3x por semana
                projectTime: 2, // 2h por dia projeto s√°fico
                studyIntensity: 'medium',
                socialTime: 'moderate'
            },
            low: {
                name: 'Energia Baixa üå±',
                academyFreq: 2, // 2x por semana
                projectTime: 1, // 1h por dia projeto s√°fico
                studyIntensity: 'low',
                socialTime: 'calm'
            }
        };

        // Base fixed schedule (non-negotiable)
        const fixedSchedule = {
            monday: [
                { time: '08:00-08:30', task: 'Acordar + Caf√© + Arruma√ß√£o', type: 'self-care', description: 'Rotina matinal completa', fixed: true },
                { time: '12:00-13:00', task: 'Almo√ßo', type: 'self-care', description: 'Refei√ß√£o principal', fixed: true },
                { time: '14:00-16:30', task: 'AULAS (fixo)', type: 'fixed-class', description: 'Aulas obrigat√≥rias', fixed: true },
                { time: '19:00-20:00', task: 'Jantar', type: 'self-care', description: 'Refei√ß√£o noturna', fixed: true }
            ],
            tuesday: [
                { time: '08:00-08:30', task: 'Acordar + Caf√© + Arruma√ß√£o', type: 'self-care', description: 'Rotina matinal completa', fixed: true },
                { time: '12:00-13:00', task: 'Almo√ßo', type: 'self-care', description: 'Refei√ß√£o principal', fixed: true },
                { time: '19:00-20:00', task: 'Jantar', type: 'self-care', description: 'Refei√ß√£o noturna', fixed: true }
            ],
            wednesday: [
                { time: '08:00-08:30', task: 'Acordar + Caf√© + Arruma√ß√£o', type: 'self-care', description: 'Rotina matinal completa', fixed: true },
                { time: '12:00-13:00', task: 'Almo√ßo', type: 'self-care', description: 'Refei√ß√£o principal', fixed: true },
                { time: '14:00-17:00', task: 'AULAS (fixo)', type: 'fixed-class', description: 'Aulas obrigat√≥rias', fixed: true },
                { time: '19:00-20:00', task: 'Jantar', type: 'self-care', description: 'Refei√ß√£o noturna', fixed: true }
            ],
            thursday: [
                { time: '08:00-08:30', task: 'Acordar + Caf√© + Arruma√ß√£o', type: 'self-care', description: 'Rotina matinal completa', fixed: true },
                { time: '12:00-13:00', task: 'Almo√ßo', type: 'self-care', description: 'Refei√ß√£o principal', fixed: true },
                { time: '18:30-20:30', task: 'AULAS (fixo)', type: 'fixed-class', description: 'Aulas obrigat√≥rias', fixed: true }
            ],
            friday: [
                { time: '08:00-08:30', task: 'Acordar + Caf√© + Arruma√ß√£o', type: 'self-care', description: 'Rotina matinal completa', fixed: true },
                { time: '12:00-13:00', task: 'Almo√ßo', type: 'self-care', description: 'Refei√ß√£o principal', fixed: true },
                { time: '14:00-16:30', task: 'AULAS (fixo)', type: 'fixed-class', description: 'Aulas obrigat√≥rias', fixed: true },
                { time: '19:00-20:00', task: 'Jantar', type: 'self-care', description: 'Refei√ß√£o noturna', fixed: true }
            ],
            saturday: [
                { time: '08:00-08:30', task: 'Acordar + Caf√© + Arruma√ß√£o', type: 'self-care', description: 'Rotina matinal relaxada', fixed: true },
                { time: '10:00-12:30', task: 'AULAS (fixo)', type: 'fixed-class', description: 'Aulas obrigat√≥rias', fixed: true },
                { time: '13:00-14:00', task: 'Almo√ßo', type: 'self-care', description: 'Refei√ß√£o principal', fixed: true },
                { time: '19:00-20:00', task: 'Jantar', type: 'self-care', description: 'Refei√ß√£o noturna', fixed: true }
            ],
            sunday: [
                { time: '08:00-08:30', task: 'Acordar devagar + Caf√© especial', type: 'self-care', description: 'Domingo relaxante', fixed: true },
                { time: '13:00-14:00', task: 'Almo√ßo especial', type: 'self-care', description: 'Refei√ß√£o em fam√≠lia', fixed: true },
                { time: '19:00-20:00', task: 'Jantar', type: 'self-care', description: 'Refei√ß√£o noturna', fixed: true }
            ]
        };

        // Initialize
        function init() {
            document.getElementById('currentDate').valueAsDate = currentDate;
            loadDefaultSchedule();
            updateDisplay();
            loadProgress();

            // Auto-save every 30 seconds
            setInterval(saveProgress, 30000);
        }

        function loadDefaultSchedule() {
            currentWeekKey = getWeekKey(currentDate);

            // Try to load existing week from history
            if (weeklyHistory[currentWeekKey]) {
                console.log(`üìö Carregando semana existente: ${currentWeekKey}`);
                allTasks = [...weeklyHistory[currentWeekKey].tasks];

                // Restore settings if available
                if (weeklyHistory[currentWeekKey].settings) {
                    const settings = weeklyHistory[currentWeekKey].settings;
                    if (settings.weeklyFocus) document.getElementById('weeklyFocus').value = settings.weeklyFocus;
                    if (settings.energyLevel) document.getElementById('energyLevel').value = settings.energyLevel;
                }

                addChatMessage('ai', `üìö Semana ${currentWeekKey} carregada! ${allTasks.length} tarefas encontradas.`);
                return;
            }

            // Generate new week if doesn't exist
            console.log(`üÜï Criando nova semana: ${currentWeekKey}`);
            const startOfWeek = getStartOfWeek(currentDate);
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

            // Load smart schedule for current week if no tasks exist
            if (allTasks.length === 0) {
                const generatedSchedule = generateSmartSchedule();

                dayNames.forEach((dayName, index) => {
                    const dayDate = new Date(startOfWeek.getTime() + (index * 24 * 60 * 60 * 1000)); // More reliable calculation

                    console.log(`Loading ${dayName} for ${dayDate.toDateString()}`); // Debug log

                    if (generatedSchedule[dayName]) {
                        generatedSchedule[dayName].forEach(task => {
                            allTasks.push({
                                id: generateId(),
                                date: formatDate(dayDate),
                                ...task
                            });
                        });
                    }
                });

                // Save the new week
                saveCurrentWeek();
                addChatMessage('ai', `üÜï Nova semana ${currentWeekKey} criada com ${allTasks.length} tarefas!`);
            }
        }

        function saveCurrentWeek() {
            if (!currentWeekKey) {
                currentWeekKey = getWeekKey(currentDate);
            }

            weeklyHistory[currentWeekKey] = {
                tasks: [...allTasks],
                settings: {
                    weeklyFocus: document.getElementById('weeklyFocus').value,
                    energyLevel: document.getElementById('energyLevel').value
                },
                created: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            console.log(`üíæ Semana ${currentWeekKey} salva com ${allTasks.length} tarefas`);
        }

        function switchToWeek(weekKey) {
            // Save current week before switching
            saveCurrentWeek();

            // Load target week
            currentWeekKey = weekKey;

            if (weeklyHistory[weekKey]) {
                allTasks = [...weeklyHistory[weekKey].tasks];

                // Restore settings
                if (weeklyHistory[weekKey].settings) {
                    const settings = weeklyHistory[weekKey].settings;
                    if (settings.weeklyFocus) document.getElementById('weeklyFocus').value = settings.weeklyFocus;
                    if (settings.energyLevel) document.getElementById('energyLevel').value = settings.energyLevel;
                }

                // Update current date to match the week
                const [year, week] = weekKey.split('-W');
                const firstDayOfYear = new Date(parseInt(year), 0, 1);
                const weekStart = new Date(firstDayOfYear.getTime() + (parseInt(week) - 1) * 7 * 24 * 60 * 60 * 1000);
                currentDate = weekStart;
                document.getElementById('currentDate').valueAsDate = currentDate;

                updateAllViews();
                addChatMessage('ai', `üìÖ Mudou para semana ${weekKey}! ${allTasks.length} tarefas carregadas.`);
            } else {
                // Create new week
                allTasks = [];
                loadDefaultSchedule();
                updateAllViews();
            }
        }

        function generateSmartSchedule() {
            const weeklyFocus = document.getElementById('weeklyFocus').value;
            const energyLevel = document.getElementById('energyLevel').value;

            const focusTemplate = scheduleTemplates[weeklyFocus];
            const energyConfig = energyAdjustments[energyLevel];

            const schedule = {};
            const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            dayNames.forEach(day => {
                schedule[day] = [...fixedSchedule[day]]; // Start with fixed tasks

                // Add variable tasks based on energy and focus
                const variableTasks = generateDayTasks(day, focusTemplate, energyConfig);
                schedule[day] = schedule[day].concat(variableTasks);

                // Sort by time
                schedule[day].sort((a, b) => a.time.localeCompare(b.time));
            });

            return schedule;
        }

        function generateDayTasks(day, focusTemplate, energyConfig) {
            const tasks = [];

            // Academy schedule based on energy
            const academyDays = getAcademyDays(energyConfig.academyFreq);
            if (academyDays.includes(day)) {
                if (day === 'saturday' || day === 'sunday') {
                    tasks.push({ time: '15:00-16:00', task: 'Academia üí™', type: 'self-care', description: 'Exerc√≠cios f√≠sicos' });
                } else {
                    tasks.push({ time: '09:00-10:00', task: 'Academia üí™', type: 'self-care', description: 'Exerc√≠cios f√≠sicos' });
                }
            }

            // School coordination tasks
            if (['monday', 'wednesday', 'friday'].includes(day)) {
                // Before classes
                tasks.push({
                    time: '10:00-13:30',
                    task: `Escola: ${focusTemplate.name} + Mensagens`,
                    type: 'coordination',
                    description: `Foco semanal: ${focusTemplate.mainTasks[0]}`
                });

                // After classes support
                const supportTime = day === 'wednesday' ? '17:00-18:00' : '16:30-17:30';
                tasks.push({
                    time: supportTime,
                    task: 'Suporte p√≥s-aula + Mensagens',
                    type: 'coordination',
                    description: 'Atendimento alunos e demandas'
                });
            }

            if (['tuesday', 'thursday'].includes(day)) {
                if (day === 'tuesday') {
                    tasks.push({
                        time: '10:00-13:00',
                        task: `Escola: ${focusTemplate.mainTasks[1]} + Mensagens`,
                        type: 'coordination',
                        description: 'Trabalho remoto coordena√ß√£o'
                    });
                } else {
                    tasks.push({
                        time: '14:00-17:30',
                        task: `Escola: ${focusTemplate.mainTasks[2]} + Mensagens`,
                        type: 'coordination',
                        description: 'Gest√£o di√°ria escola'
                    });
                }
            }

            if (day === 'saturday') {
                tasks.push({
                    time: '12:30-13:00',
                    task: 'Suporte p√≥s-aula',
                    type: 'coordination',
                    description: 'Atendimento final da semana'
                });
            }

            // University tasks
            const universityTasks = getUniversityTasks(day, energyConfig.studyIntensity);
            tasks.push(...universityTasks);

            // S√°fico project tasks
            const projectTasks = getProjectTasks(day, energyConfig.projectTime);
            tasks.push(...projectTasks);

            // Personal time and self-care
            const personalTasks = getPersonalTasks(day, energyConfig.socialTime);
            tasks.push(...personalTasks);

            return tasks;
        }

        function getAcademyDays(frequency) {
            const allDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const academyDays = {
                5: ['monday', 'tuesday', 'wednesday', 'thursday', 'saturday'],
                3: ['tuesday', 'thursday', 'saturday'],
                2: ['tuesday', 'saturday']
            };
            return academyDays[frequency] || academyDays[3];
        }

        function getUniversityTasks(day, intensity) {
            const tasks = [];
            const intensityConfig = {
                high: { duration: 2, frequency: 5 },
                medium: { duration: 1.5, frequency: 4 },
                low: { duration: 1, frequency: 3 }
            };

            const config = intensityConfig[intensity];
            const studyDays = ['monday', 'tuesday', 'thursday', 'saturday', 'sunday'].slice(0, config.frequency);

            if (studyDays.includes(day)) {
                if (day === 'monday') {
                    tasks.push({
                        time: '20:00-22:00',
                        task: 'Faculdade: Aulas online + Atividades',
                        type: 'university',
                        description: 'Estudos e tarefas acad√™micas'
                    });
                } else if (day === 'tuesday') {
                    tasks.push({
                        time: '14:00-16:00',
                        task: 'Faculdade: Estudo + Est√°gio',
                        type: 'university',
                        description: 'Desenvolvimento acad√™mico'
                    });
                } else if (day === 'thursday') {
                    tasks.push({
                        time: '10:30-12:00',
                        task: 'Faculdade: Atividades + Est√°gio',
                        type: 'university',
                        description: 'Tarefas e est√°gio'
                    });
                } else if (day === 'saturday') {
                    tasks.push({
                        time: '14:00-16:00',
                        task: 'Faculdade: Revis√£o + Est√°gio',
                        type: 'university',
                        description: 'Recupera√ß√£o e est√°gio'
                    });
                } else if (day === 'sunday') {
                    tasks.push({
                        time: '14:00-16:00',
                        task: 'Faculdade: Planejamento semanal',
                        type: 'university',
                        description: 'Organiza√ß√£o acad√™mica'
                    });
                }
            }

            return tasks;
        }

        function getProjectTasks(day, duration) {
            const tasks = [];

            if (day === 'tuesday') {
                tasks.push({
                    time: '16:30-18:30',
                    task: `Projeto S√°fico: Cria√ß√£o de conte√∫do (${duration}h)`,
                    type: 'personal-project',
                    description: 'Desenvolvimento criativo'
                });
            } else if (day === 'wednesday') {
                tasks.push({
                    time: '20:00-22:00',
                    task: `Projeto S√°fico: Divulga√ß√µes pagas (${duration}h)`,
                    type: 'personal-project',
                    description: 'Marketing e parcerias'
                });
            } else if (day === 'friday') {
                tasks.push({
                    time: '17:30-19:00',
                    task: `Projeto S√°fico: Programa√ß√£o fim de semana`,
                    type: 'personal-project',
                    description: 'Planejamento estrat√©gico'
                });
            } else if (day === 'saturday') {
                tasks.push({
                    time: '16:00-18:00',
                    task: `Projeto S√°fico: Conte√∫do criativo (${duration}h)`,
                    type: 'personal-project',
                    description: 'Cria√ß√£o livre e experimental'
                });
            } else if (day === 'sunday') {
                tasks.push({
                    time: '16:00-18:00',
                    task: `Projeto S√°fico: Planejamento semanal`,
                    type: 'personal-project',
                    description: 'Estrat√©gia e organiza√ß√£o'
                });
            }

            return tasks;
        }

        function getPersonalTasks(day, socialLevel) {
            const tasks = [];

            // Daily personal time with wife
            if (day === 'monday') {
                tasks.push({
                    time: '22:00-23:00',
                    task: 'Tempo com a esposa ‚ù§Ô∏è',
                    type: 'free-time',
                    description: 'Conversa e conex√£o'
                });
            } else if (day === 'tuesday') {
                tasks.push({
                    time: '20:30-22:00',
                    task: 'Leitura ou s√©rie üìö',
                    type: 'free-time',
                    description: 'Entretenimento relaxante'
                });
            } else if (day === 'wednesday') {
                tasks.push({
                    time: '22:00-23:00',
                    task: 'Arte livre + Esposa',
                    type: 'free-time',
                    description: 'Criatividade e relacionamento'
                });
            } else if (day === 'thursday') {
                if (socialLevel === 'active') {
                    tasks.push({
                        time: '21:00-23:00',
                        task: 'Amigos ou s√©rie',
                        type: 'free-time',
                        description: 'Socializa√ß√£o ativa'
                    });
                } else {
                    tasks.push({
                        time: '21:00-22:30',
                        task: 'S√©rie ou leitura',
                        type: 'free-time',
                        description: 'Entretenimento calmo'
                    });
                }
            } else if (day === 'friday') {
                tasks.push({
                    time: '20:00-22:00',
                    task: 'Relaxar com a esposa ‚ù§Ô∏è',
                    type: 'free-time',
                    description: 'Descanso e conex√£o'
                });
            } else if (day === 'saturday') {
                tasks.push({
                    time: '20:00-22:00',
                    task: 'Tempo livre: leitura/s√©rie/arte',
                    type: 'free-time',
                    description: 'Entretenimento variado'
                });
            } else if (day === 'sunday') {
                if (socialLevel === 'active') {
                    tasks.push({
                        time: '18:00-19:00',
                        task: 'Amigos ou arte livre',
                        type: 'free-time',
                        description: 'Socializa√ß√£o criativa'
                    });
                }
                tasks.push({
                    time: '20:00-22:00',
                    task: 'Tempo especial com a esposa ‚ù§Ô∏è',
                    type: 'free-time',
                    description: 'Relacionamento e planejamento'
                });
            }

            // Add coffee breaks
            if (['tuesday', 'thursday'].includes(day)) {
                tasks.push({
                    time: '15:30-16:00',
                    task: 'Lanche + Pausa',
                    type: 'self-care',
                    description: 'Pausa para recarregar'
                });
            }

            return tasks;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getWeekKey(date) {
            const startOfWeek = getStartOfWeek(date);
            const year = startOfWeek.getFullYear();
            const weekNumber = getWeekNumber(startOfWeek);
            return `${year}-W${weekNumber.toString().padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function getStartOfWeek(date) {
            const start = new Date(date);
            const day = start.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const diff = start.getDate() - day; // Calculate difference to get to Sunday
            start.setDate(diff);
            start.setHours(0, 0, 0, 0); // Reset time to avoid timezone issues
            return start;
        }

        // View Management
        function setView(view) {
            currentView = view;

            // Update button states
            document.querySelectorAll('[id$="ViewBtn"]').forEach(btn => {
                btn.className = btn.className.replace('bg-indigo-500 text-white', 'text-gray-600 hover:text-gray-900');
            });
            document.getElementById(view + 'ViewBtn').className =
                document.getElementById(view + 'ViewBtn').className.replace('text-gray-600 hover:text-gray-900', 'bg-indigo-500 text-white');

            // Show/hide views
            document.querySelectorAll('.view-container').forEach(container => {
                container.classList.add('hidden');
            });
            document.getElementById(view + 'View').classList.remove('hidden');

            // Force refresh all views to ensure synchronization
            updateAllViews();
        }

        function navigateDate(direction) {
            // Save current week before navigating
            saveCurrentWeek();

            if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            }

            // Check if we moved to a different week
            const newWeekKey = getWeekKey(currentDate);
            if (newWeekKey !== currentWeekKey) {
                console.log(`üìÖ Mudando de semana: ${currentWeekKey} ‚Üí ${newWeekKey}`);
                switchToWeek(newWeekKey);
            }

            document.getElementById('currentDate').valueAsDate = currentDate;
            updateDisplay();
        }

        function goToToday() {
            currentDate = new Date();
            document.getElementById('currentDate').valueAsDate = currentDate;
            updateDisplay();
        }

        function updateCurrentDate() {
            const newDate = new Date(document.getElementById('currentDate').value);
            if (!isNaN(newDate)) {
                currentDate = newDate;
                updateDisplay();
            }
        }

        function updateDisplay() {
            updateDateDisplay();

            if (currentView === 'day') {
                renderDayView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'month') {
                renderMonthView();
            }
        }

        function updateAllViews() {
            // Force update all views regardless of current view
            updateDateDisplay();
            renderDayView();
            renderWeekView();
            renderMonthView();
        }

        function updateDateDisplay() {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };

            let displayText = '';

            if (currentView === 'day') {
                displayText = currentDate.toLocaleDateString('pt-BR', options);
            } else if (currentView === 'week') {
                const startOfWeek = getStartOfWeek(currentDate);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                displayText = `${startOfWeek.getDate()} - ${endOfWeek.getDate()} de ${startOfWeek.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
            } else if (currentView === 'month') {
                displayText = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            }

            document.getElementById('currentDateDisplay').textContent = displayText;

            // Update week display
            const weekKey = getWeekKey(currentDate);
            const weekInfo = weeklyHistory[weekKey] ?
                `${weekKey} (${weeklyHistory[weekKey].tasks.length} tarefas)` :
                `${weekKey} (nova semana)`;
            document.getElementById('currentWeekDisplay').textContent = weekInfo;
        }

        // Day View
        function renderDayView() {
            const daySchedule = document.getElementById('daySchedule');
            const dayTitle = document.getElementById('dayTitle');
            const daySubtitle = document.getElementById('daySubtitle');

            const dayName = currentDate.toLocaleDateString('pt-BR', { weekday: 'long' });
            const dayDate = formatDate(currentDate);

            dayTitle.textContent = dayName.charAt(0).toUpperCase() + dayName.slice(1);
            daySubtitle.textContent = currentDate.toLocaleDateString('pt-BR');

            const dayTasks = allTasks.filter(task => task.date === dayDate).sort((a, b) => a.time.localeCompare(b.time));

            daySchedule.innerHTML = '';

            if (dayTasks.length === 0) {
                daySchedule.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìÖ</div>
                        <p>Nenhuma tarefa agendada para hoje</p>
                        <p class="text-sm">Clique em "Adicionar Nova Tarefa" para come√ßar</p>
                    </div>
                `;
            } else {
                dayTasks.forEach(task => {
                    const taskElement = createTaskElement(task);
                    daySchedule.appendChild(taskElement);
                });
            }
        }

        // Week View
        function renderWeekView() {
            const weekSchedule = document.getElementById('weekSchedule');
            const startOfWeek = getStartOfWeek(currentDate);
            const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const dayColors = [
                'from-pink-500 to-red-500',
                'from-red-500 to-pink-500',
                'from-blue-500 to-indigo-500',
                'from-green-500 to-teal-500',
                'from-purple-500 to-pink-500',
                'from-yellow-500 to-orange-500',
                'from-indigo-500 to-purple-500'
            ];

            weekSchedule.innerHTML = '';

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek.getTime() + (i * 24 * 60 * 60 * 1000)); // More reliable date calculation
                const dayDateStr = formatDate(dayDate);
                const dayTasks = allTasks.filter(task => task.date === dayDateStr).sort((a, b) => a.time.localeCompare(b.time));

                // Debug log to check dates
                console.log(`Day ${i}: ${dayNames[i]} = ${dayDate.toDateString()} (${dayDateStr})`);

                const dayColumn = document.createElement('div');
                dayColumn.className = 'bg-white rounded-xl shadow-lg overflow-hidden';
                dayColumn.innerHTML = `
                    <div class="bg-gradient-to-r ${dayColors[i]} text-white p-4">
                        <h3 class="font-bold text-lg">${dayNames[i]}</h3>
                        <p class="text-sm opacity-90">${dayDate.getDate()}/${dayDate.getMonth() + 1}</p>
                    </div>
                    <div class="p-4 space-y-2 min-h-96">
                        ${dayTasks.length === 0 ?
                            '<div class="text-center text-gray-400 py-4"><div class="text-2xl mb-1">üìÖ</div><p class="text-xs">Sem tarefas</p></div>' :
                            dayTasks.map(task => createTaskElement(task, true).outerHTML).join('')
                        }
                        <button onclick="quickAddTaskForDate('${dayDateStr}')" class="w-full mt-2 bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 rounded-lg text-sm transition-colors border border-dashed border-gray-300">
                            ‚ûï Adicionar
                        </button>
                    </div>
                `;

                weekSchedule.appendChild(dayColumn);
            }
        }

        // Month View
        function renderMonthView() {
            const monthCalendar = document.getElementById('monthCalendar');
            const monthTitle = document.getElementById('monthTitle');

            monthTitle.textContent = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            startDate.setHours(0, 0, 0, 0); // Reset time to avoid timezone issues

            monthCalendar.innerHTML = '';

            for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
                const cellDate = new Date(startDate.getTime() + (i * 24 * 60 * 60 * 1000));
                const cellDateStr = formatDate(cellDate);
                const cellTasks = allTasks.filter(task => task.date === cellDateStr);

                const isCurrentMonth = cellDate.getMonth() === currentDate.getMonth();
                const isToday = cellDateStr === formatDate(new Date());

                const dayCell = document.createElement('div');
                dayCell.className = `month-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;
                dayCell.onclick = () => {
                    currentDate = new Date(cellDate);
                    document.getElementById('currentDate').valueAsDate = currentDate;
                    setView('day');
                };

                dayCell.innerHTML = `
                    <div class="font-medium text-sm mb-1">${cellDate.getDate()}</div>
                    ${cellTasks.slice(0, 3).map(task => `
                        <div class="month-task ${task.type}" title="${task.task} (${task.time})">
                            ${task.task.substring(0, 15)}${task.task.length > 15 ? '...' : ''}
                        </div>
                    `).join('')}
                    ${cellTasks.length > 3 ? `<div class="month-task bg-gray-200 text-gray-600">+${cellTasks.length - 3} mais</div>` : ''}
                `;

                monthCalendar.appendChild(dayCell);
            }
        }

        function createTaskElement(task, compact = false) {
            const taskElement = document.createElement('div');
            taskElement.className = `time-slot ${task.type} p-3 rounded-lg ${compact ? 'text-xs' : ''}`;
            taskElement.onclick = () => editTask(task.id);

            taskElement.innerHTML = `
                <div class="font-medium ${compact ? 'text-xs' : 'text-sm'}">${task.time}</div>
                <div class="${compact ? 'text-xs' : 'text-xs'} text-gray-600">${task.task}</div>
                ${task.description ? `<div class="text-xs text-gray-500 mt-1">${task.description}</div>` : ''}
                <div class="edit-controls">
                    <button onclick="event.stopPropagation(); editTask('${task.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">‚úèÔ∏è</button>
                    <button onclick="event.stopPropagation(); deleteTaskById('${task.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">üóëÔ∏è</button>
                </div>
            `;

            return taskElement;
        }

        // Task Management
        function quickAddTask() {
            const taskDate = formatDate(currentDate);
            quickAddTaskForDate(taskDate);
        }

        function addNewTask() {
            const taskDate = formatDate(currentDate);
            quickAddTaskForDate(taskDate);
        }

        function quickAddTaskForDate(date) {
            editingTask = null;

            // Pre-fill with date
            document.getElementById('editTaskDate').value = date;
            document.getElementById('editTaskName').value = '';
            document.getElementById('editStartTime').value = '09:00';
            document.getElementById('editEndTime').value = '10:00';
            document.getElementById('editTaskType').value = 'coordination';
            document.getElementById('editTaskDescription').value = '';

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editTaskName').focus();
        }

        function editTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            editingTask = task;

            // Parse time range
            const [startTime, endTime] = task.time.split('-');

            document.getElementById('editTaskName').value = task.task;
            document.getElementById('editStartTime').value = startTime;
            document.getElementById('editEndTime').value = endTime || startTime;
            document.getElementById('editTaskDate').value = task.date;
            document.getElementById('editTaskType').value = task.type;
            document.getElementById('editTaskDescription').value = task.description || '';

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editTaskName').focus();
        }

        function saveTaskEdit(event) {
            event.preventDefault();

            const taskData = {
                task: document.getElementById('editTaskName').value,
                time: `${document.getElementById('editStartTime').value}-${document.getElementById('editEndTime').value}`,
                date: document.getElementById('editTaskDate').value,
                type: document.getElementById('editTaskType').value,
                description: document.getElementById('editTaskDescription').value
            };

            if (editingTask) {
                // Find and update the task in the allTasks array
                const taskIndex = allTasks.findIndex(t => t.id === editingTask.id);
                if (taskIndex !== -1) {
                    allTasks[taskIndex] = { ...allTasks[taskIndex], ...taskData };
                }
                addChatMessage('ai', `‚úÖ Tarefa "${taskData.task}" atualizada com sucesso!`);
            } else {
                // Create new task
                allTasks.push({
                    id: generateId(),
                    ...taskData
                });
                addChatMessage('ai', `‚úÖ Nova tarefa "${taskData.task}" adicionada para ${new Date(taskData.date).toLocaleDateString('pt-BR')}!`);
            }

            closeEditModal();
            updateAllViews(); // Force update all views
            saveCurrentWeek(); // Save current week immediately
            saveProgress();
        }

        function deleteTask() {
            if (!editingTask) {
                console.error('Nenhuma tarefa sendo editada');
                return;
            }

            // Create custom confirmation modal
            showDeleteConfirmation(editingTask, () => {
                allTasks = allTasks.filter(t => t.id !== editingTask.id);
                addChatMessage('ai', `üóëÔ∏è Tarefa "${editingTask.task}" removida da agenda.`);
                closeEditModal();
                updateAllViews();
                saveProgress();
                showNotification('Exclu√≠do!', `Tarefa "${editingTask.task}" removida`, 'success');
            });
        }

        function deleteTaskById(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) {
                console.error('Tarefa n√£o encontrada:', taskId);
                return;
            }

            // Create custom confirmation modal
            showDeleteConfirmation(task, () => {
                allTasks = allTasks.filter(t => t.id !== taskId);
                addChatMessage('ai', `üóëÔ∏è Tarefa "${task.task}" removida da agenda.`);
                updateAllViews();
                saveProgress();
                showNotification('Exclu√≠do!', `Tarefa "${task.task}" removida`, 'success');
            });
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingTask = null;
        }

        // Chat System (keeping existing functionality)
        function addChatMessage(sender, message, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start gap-3';

            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">EU</div>
                    <div class="bg-purple-100 rounded-lg p-3 shadow-sm max-w-md">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-indigo-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">AI</div>
                    <div class="bg-white rounded-lg p-3 shadow-sm max-w-md">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addChatMessage('user', message, true);
            chatHistory.push({ sender: 'user', message });
            input.value = '';

            setTimeout(() => {
                const response = analyzeAndReplan(message);
                addChatMessage('ai', response);
                chatHistory.push({ sender: 'ai', message: response });
                updateDisplay();
                saveProgress();
            }, 1000);
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function quickDemand(type) {
            const templates = {
                'reuniao': 'Preciso agendar uma reuni√£o de 1 hora para esta semana',
                'apresentacao': 'Preciso preparar uma apresenta√ß√£o de 2 horas para sexta-feira',
                'projeto': 'Surgiu um novo projeto que vai precisar de 3 horas de dedica√ß√£o',
                'emergencia': 'Tenho uma demanda urgente que precisa ser resolvida hoje'
            };

            document.getElementById('chatInput').value = templates[type];
            sendChatMessage();
        }

        function analyzeAndReplan(userMessage) {
            const message = userMessage.toLowerCase();
            const originalMessage = userMessage;

            console.log('ü§ñ Analisando:', originalMessage);

            // 1. AN√ÅLISE DE DATA - Muito mais inteligente
            let targetDate = formatDate(currentDate); // Default: data atual

            // Padr√µes de data espec√≠fica (18/08, 18-08, dia 18, etc.)
            const specificDateMatch = message.match(/(?:dia\s*)?(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
            const dayOnlyMatch = message.match(/(?:dia\s+)(\d{1,2})(?!\d)/);

            if (specificDateMatch) {
                const day = parseInt(specificDateMatch[1]);
                const month = parseInt(specificDateMatch[2]);
                const year = specificDateMatch[3] ?
                    (specificDateMatch[3].length === 2 ? 2000 + parseInt(specificDateMatch[3]) : parseInt(specificDateMatch[3]))
                    : currentDate.getFullYear();

                const targetDateObj = new Date(year, month - 1, day);
                targetDate = formatDate(targetDateObj);
                console.log('üìÖ Data espec√≠fica detectada:', targetDate);
            } else if (dayOnlyMatch) {
                // "dia 18" - assume m√™s atual
                const day = parseInt(dayOnlyMatch[1]);
                const targetDateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                targetDate = formatDate(targetDateObj);
                console.log('üìÖ Dia do m√™s detectado:', targetDate);
            }

            // Contexto da aba atual - "nesse dia", "hoje", etc.
            if (message.includes('nesse dia') || message.includes('neste dia') ||
                message.includes('no dia') || message.includes('esse dia')) {
                targetDate = formatDate(currentDate); // Usa a data da aba atual
                console.log('üìÖ Contexto "nesse dia" - usando data atual da aba:', targetDate);
            }

            // Dias da semana relativos
            const dayMatch = message.match(/(segunda|ter√ßa|terca|quarta|quinta|sexta|sabado|s√°bado|domingo|hoje|amanh√£)/);
            if (dayMatch && !specificDateMatch && !dayOnlyMatch) {
                const dayMapping = {
                    'segunda': 1, 'ter√ßa': 2, 'terca': 2, 'quarta': 3,
                    'quinta': 4, 'sexta': 5, 'sabado': 6, 's√°bado': 6, 'domingo': 0,
                    'hoje': currentDate.getDay(), 'amanh√£': (currentDate.getDay() + 1) % 7
                };

                const targetDay = dayMapping[dayMatch[1]];
                const targetDateObj = new Date(currentDate);
                const daysUntilTarget = (targetDay - currentDate.getDay() + 7) % 7;
                targetDateObj.setDate(currentDate.getDate() + daysUntilTarget);
                targetDate = formatDate(targetDateObj);
                console.log('üìÖ Dia da semana detectado:', dayMatch[1], '‚Üí', targetDate);
            }

            // 2. AN√ÅLISE DE HOR√ÅRIO - Muito mais precisa
            let startTime = null;
            let endTime = null;
            let duration = 1; // default

            // Padr√£o: "das 18:30-20:30" ou "18:30 √†s 20:30"
            const timeRangeMatch = message.match(/(?:das?\s*)?(\d{1,2}):?(\d{0,2})\s*(?:√†s?|at√©|-|a)\s*(?:umas?\s*)?(\d{1,2}):?(\d{0,2})/);

            if (timeRangeMatch) {
                const startHour = parseInt(timeRangeMatch[1]);
                const startMin = timeRangeMatch[2] ? parseInt(timeRangeMatch[2]) : 0;
                const endHour = parseInt(timeRangeMatch[3]);
                const endMin = timeRangeMatch[4] ? parseInt(timeRangeMatch[4]) : 0;

                startTime = `${startHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}`;
                endTime = `${endHour.toString().padStart(2, '0')}:${endMin.toString().padStart(2, '0')}`;

                console.log('‚è∞ Hor√°rio espec√≠fico detectado:', startTime, '-', endTime);
            } else {
                // Padr√£o: "√†s 10", "as dez", "10h"
                const singleTimeMatch = message.match(/(?:√†s?|as)\s*(?:umas?\s*)?(\d{1,2})(?::(\d{2}))?(?:h|horas?)?/);
                if (singleTimeMatch) {
                    const hour = parseInt(singleTimeMatch[1]);
                    const min = singleTimeMatch[2] ? parseInt(singleTimeMatch[2]) : 0;
                    startTime = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;

                    // Tentar detectar dura√ß√£o ou hor√°rio final
                    const durationMatch = message.match(/(?:at√©|talvez.*at√©).*?(\d{1,2})(?::(\d{2}))?(?:h|horas?)?/);
                    if (durationMatch) {
                        const endHour = parseInt(durationMatch[1]);
                        const endMin = durationMatch[2] ? parseInt(durationMatch[2]) : 0;
                        endTime = `${endHour.toString().padStart(2, '0')}:${endMin.toString().padStart(2, '0')}`;
                    } else {
                        // Dura√ß√£o padr√£o baseada no tipo de atividade
                        duration = detectActivityDuration(message);
                        endTime = addHours(startTime, duration);
                    }

                    console.log('‚è∞ Hor√°rio √∫nico detectado:', startTime, '‚Üí', endTime);
                }
            }

            // 3. AN√ÅLISE DO TIPO DE ATIVIDADE - Mais inteligente
            let taskName = 'Nova atividade';
            let taskType = 'coordination';

            // Detectar atividades espec√≠ficas
            const activities = {
                'mentoria': { name: 'Mentoria', type: 'coordination', defaultDuration: 2 },
                'acif': { name: 'ACIF', type: 'coordination', defaultDuration: 2 },
                'sal√£o': { name: 'Sal√£o', type: 'self-care', defaultDuration: 2 },
                'salao': { name: 'Sal√£o', type: 'self-care', defaultDuration: 2 },
                'academia': { name: 'Academia', type: 'self-care', defaultDuration: 1 },
                'reuni√£o': { name: 'Reuni√£o', type: 'coordination', defaultDuration: 1 },
                'reuniao': { name: 'Reuni√£o', type: 'coordination', defaultDuration: 1 },
                'apresenta√ß√£o': { name: 'Apresenta√ß√£o', type: 'coordination', defaultDuration: 2 },
                'apresentacao': { name: 'Apresenta√ß√£o', type: 'coordination', defaultDuration: 2 },
                'm√©dico': { name: 'Consulta m√©dica', type: 'self-care', defaultDuration: 1 },
                'medico': { name: 'Consulta m√©dica', type: 'self-care', defaultDuration: 1 },
                'dentista': { name: 'Dentista', type: 'self-care', defaultDuration: 1 },
                'faculdade': { name: 'Faculdade', type: 'university', defaultDuration: 2 },
                'aula': { name: 'Aula extra', type: 'fixed-class', defaultDuration: 2 }
            };

            for (const [keyword, activity] of Object.entries(activities)) {
                if (message.includes(keyword)) {
                    taskName = activity.name;
                    taskType = activity.type;
                    if (!endTime && !timeRangeMatch) {
                        duration = activity.defaultDuration;
                    }
                    break;
                }
            }

            // Detectar local/contexto adicional
            const locationMatch = message.match(/(?:na|no|em)\s+([a-z√°√†√¢√£√©√™√≠√≥√¥√µ√∫√ß\s]+?)(?:\s|$|das|√†s|,)/i);
            if (locationMatch && !message.includes('mentoria na acif')) {
                const location = locationMatch[1].trim();
                if (location.length > 2) {
                    taskName += ` (${location})`;
                }
            }

            // 4. FINALIZAR HOR√ÅRIOS
            if (!startTime) {
                const dayTasks = allTasks.filter(task => task.date === targetDate);
                startTime = findAvailableTime(dayTasks, duration);
                console.log('‚è∞ Hor√°rio autom√°tico encontrado:', startTime);
            }

            if (!endTime) {
                endTime = addHours(startTime, duration);
            }

            // 5. VERIFICAR CONFLITOS
            const dayTasks = allTasks.filter(task => task.date === targetDate);
            const hasConflict = checkTimeConflict(dayTasks, startTime, endTime);

            if (hasConflict && !timeRangeMatch) {
                // Se n√£o foi hor√°rio espec√≠fico, tenta encontrar outro
                const alternativeTime = findAvailableTime(dayTasks, duration);
                const conflictMessage = `‚ö†Ô∏è Conflito detectado no hor√°rio ${startTime}-${endTime}. Sugest√£o: ${alternativeTime}-${addHours(alternativeTime, duration)}. Confirma o hor√°rio original mesmo assim?`;

                // Por enquanto, vamos manter o hor√°rio original se foi espec√≠fico
                console.log('‚ö†Ô∏è Conflito detectado, mas mantendo hor√°rio espec√≠fico');
            }

            // 6. CRIAR A TAREFA
            const newTask = {
                id: generateId(),
                date: targetDate,
                time: `${startTime}-${endTime}`,
                task: taskName,
                type: taskType,
                description: `Adicionado via chat: ${originalMessage}`
            };

            allTasks.push(newTask);

            // Force update all views after adding new task
            updateAllViews();

            // 7. RESPOSTA INTELIGENTE
            const targetDateObj = new Date(targetDate);
            const dayName = targetDateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
            const dateFormatted = targetDateObj.toLocaleDateString('pt-BR');

            let response = `‚úÖ "${taskName}" agendado!\n`;
            response += `üìÖ ${dayName}, ${dateFormatted}\n`;
            response += `‚è∞ ${startTime} √†s ${endTime}`;

            if (hasConflict) {
                response += `\n‚ö†Ô∏è Aten√ß√£o: Pode haver conflito com outras atividades neste hor√°rio.`;
            }

            console.log('‚úÖ Tarefa criada:', newTask);
            return response;
        }

        function detectActivityDuration(message) {
            // Dura√ß√µes baseadas no tipo de atividade
            if (message.includes('sal√£o') || message.includes('salao')) return 2;
            if (message.includes('mentoria')) return 2;
            if (message.includes('academia')) return 1;
            if (message.includes('m√©dico') || message.includes('medico')) return 1;
            if (message.includes('dentista')) return 1;
            if (message.includes('reuni√£o') || message.includes('reuniao')) return 1;
            if (message.includes('apresenta√ß√£o') || message.includes('apresentacao')) return 2;
            if (message.includes('faculdade')) return 2;

            return 1; // padr√£o
        }

        function findAvailableTime(dayTasks, duration) {
            const workingHours = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00', '19:00', '20:00'];

            for (let time of workingHours) {
                const endTime = addHours(time, duration);
                if (!checkTimeConflict(dayTasks, time, endTime)) {
                    return time;
                }
            }

            return '09:00'; // fallback
        }

        function addHours(time, hours) {
            const [h, m] = time.split(':').map(Number);
            const newHour = h + hours;
            return `${newHour.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function checkTimeConflict(dayTasks, startTime, endTime) {
            const start = timeToMinutes(startTime);
            const end = timeToMinutes(endTime);

            return dayTasks.some(task => {
                const [taskStart, taskEnd] = task.time.split('-');
                const taskStartMin = timeToMinutes(taskStart);
                const taskEndMin = timeToMinutes(taskEnd);

                return (start < taskEndMin && end > taskStartMin);
            });
        }

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Utility Functions
        function showTips() {
            const tips = [
                "Clique em qualquer tarefa para edit√°-la diretamente",
                "Use as visualiza√ß√µes Dia/Semana/M√™s para diferentes perspectivas",
                "O chat inteligente pode reorganizar sua agenda automaticamente",
                "Todas as altera√ß√µes s√£o salvas automaticamente",
                "Use Ctrl+Click para edi√ß√£o r√°pida de tarefas"
            ];

            const tipsDiv = document.getElementById('floatingTips');
            const tipText = document.getElementById('dailyTip');
            const randomTip = tips[Math.floor(Math.random() * tips.length)];

            tipText.textContent = randomTip;
            tipsDiv.classList.remove('hidden');
        }

        function hideTips() {
            document.getElementById('floatingTips').classList.add('hidden');
        }

        function exportSchedule() {
            let exportText = `üìÖ MINHA AGENDA DIN√ÇMICA\n`;
            exportText += `üìÜ Exportado em: ${new Date().toLocaleString('pt-BR')}\n\n`;

            if (allTasks.length === 0) {
                exportText += `‚ö†Ô∏è Nenhuma tarefa encontrada na agenda.\n\n`;
                exportText += `ü§ñ Gerado pelo Planejador Din√¢mico`;

                // Show in modal instead of clipboard
                showExportModal(exportText);
                return;
            }

            // Group tasks by date
            const tasksByDate = {};
            allTasks.forEach(task => {
                if (!tasksByDate[task.date]) {
                    tasksByDate[task.date] = [];
                }
                tasksByDate[task.date].push(task);
            });

            // Sort dates and export
            Object.keys(tasksByDate).sort().forEach(date => {
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                exportText += `üìÖ ${dayName.toUpperCase()} - ${dateObj.toLocaleDateString('pt-BR')}\n`;

                tasksByDate[date].sort((a, b) => a.time.localeCompare(b.time)).forEach(task => {
                    exportText += `  ${task.time} - ${task.task}\n`;
                    if (task.description) {
                        exportText += `    üí≠ ${task.description}\n`;
                    }
                });
                exportText += `\n`;
            });

            exportText += `ü§ñ Gerado pelo Planejador Din√¢mico`;

            // Show in modal with copy option
            showExportModal(exportText);
        }

        function showExportModal(exportText) {
            const exportModal = document.createElement('div');
            exportModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            exportModal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-96 overflow-hidden shadow-2xl">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4">
                        <h3 class="text-lg font-bold">üì± Agenda Exportada</h3>
                        <p class="text-sm opacity-90">Sua agenda completa est√° pronta!</p>
                    </div>
                    <div class="p-4">
                        <textarea readonly class="w-full h-64 p-3 border border-gray-300 rounded-lg text-sm font-mono resize-none"
                                  id="exportTextArea">${exportText}</textarea>
                        <div class="flex gap-3 mt-4">
                            <button onclick="copyExportText()"
                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                üìã Copiar Texto
                            </button>
                            <button onclick="document.body.removeChild(this.closest('.fixed'))"
                                    class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(exportModal);
        }

        function copyExportText() {
            const textArea = document.getElementById('exportTextArea');
            textArea.select();
            textArea.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                showNotification('Copiado!', 'Agenda copiada para √°rea de transfer√™ncia', 'success');
            } catch (err) {
                // Fallback for clipboard API
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textArea.value).then(() => {
                        showNotification('Copiado!', 'Agenda copiada para √°rea de transfer√™ncia', 'success');
                    }).catch(() => {
                        showNotification('Erro', 'N√£o foi poss√≠vel copiar. Selecione o texto manualmente.', 'error');
                    });
                } else {
                    showNotification('Erro', 'N√£o foi poss√≠vel copiar. Selecione o texto manualmente.', 'error');
                }
            }
        }

        function showDeleteConfirmation(task, onConfirm) {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white rounded-xl max-w-md w-full shadow-2xl">
                    <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white p-4 rounded-t-xl">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            üóëÔ∏è Confirmar Exclus√£o
                        </h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-700 mb-2">Tem certeza que deseja excluir esta tarefa?</p>
                        <div class="bg-gray-50 p-3 rounded-lg mb-4">
                            <div class="font-medium text-gray-900">${task.task}</div>
                            <div class="text-sm text-gray-600">${task.time}</div>
                            <div class="text-xs text-gray-500">${new Date(task.date).toLocaleDateString('pt-BR')}</div>
                        </div>
                        <p class="text-sm text-red-600 mb-4">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita.</p>
                        <div class="flex gap-3">
                            <button onclick="confirmDelete()"
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                üóëÔ∏è Sim, Excluir
                            </button>
                            <button onclick="cancelDelete()"
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add event handlers
            window.confirmDelete = () => {
                document.body.removeChild(confirmModal);
                onConfirm();
                delete window.confirmDelete;
                delete window.cancelDelete;
            };

            window.cancelDelete = () => {
                document.body.removeChild(confirmModal);
                delete window.confirmDelete;
                delete window.cancelDelete;
            };

            document.body.appendChild(confirmModal);
        }

        function showNotification(title, message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-20 ${colors[type]} text-white p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
            notification.innerHTML = `
                <div class="font-bold">${title}</div>
                <div class="text-sm">${message}</div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function saveProgress() {
            // Save current week first
            saveCurrentWeek();

            const progress = {
                allTasks: allTasks,
                chatHistory: chatHistory,
                currentView: currentView,
                currentDate: currentDate.toISOString(),
                currentWeekKey: currentWeekKey,
                weeklyHistory: weeklyHistory, // Save all weeks
                weeklyFocus: document.getElementById('weeklyFocus').value,
                energyLevel: document.getElementById('energyLevel').value,
                lastSaved: new Date().toISOString()
            };

            localStorage.setItem('dynamicPlannerProgress', JSON.stringify(progress));
            console.log(`üíæ Progresso salvo: ${Object.keys(weeklyHistory).length} semanas no hist√≥rico`);
        }

        function loadProgress() {
            const saved = localStorage.getItem('dynamicPlannerProgress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);

                    // Load weekly history first
                    if (progress.weeklyHistory) {
                        weeklyHistory = progress.weeklyHistory;
                        console.log(`üìö Carregado hist√≥rico: ${Object.keys(weeklyHistory).length} semanas`);
                    }

                    if (progress.currentWeekKey) {
                        currentWeekKey = progress.currentWeekKey;
                    }

                    if (progress.allTasks) {
                        allTasks = progress.allTasks;
                    }

                    if (progress.chatHistory) {
                        chatHistory = progress.chatHistory;
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.innerHTML = '';

                        if (chatHistory.length === 0) {
                            chatMessages.innerHTML = `
                                <div class="flex items-start gap-3">
                                    <div class="bg-indigo-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">AI</div>
                                    <div class="bg-white rounded-lg p-3 shadow-sm max-w-md">
                                        <p class="text-sm">Oi! Agora voc√™ pode navegar entre semanas e todas ficam salvas automaticamente! Use o bot√£o "üìö Hist√≥rico" para ver todas as suas semanas. üòä</p>
                                    </div>
                                </div>
                            `;
                        } else {
                            chatHistory.forEach(msg => {
                                addChatMessage(msg.sender, msg.message, msg.sender === 'user');
                            });
                        }
                    }

                    if (progress.currentView) {
                        setView(progress.currentView);
                    }

                    if (progress.currentDate) {
                        currentDate = new Date(progress.currentDate);
                        document.getElementById('currentDate').valueAsDate = currentDate;
                    }

                    if (progress.weeklyFocus) {
                        document.getElementById('weeklyFocus').value = progress.weeklyFocus;
                    }

                    if (progress.energyLevel) {
                        document.getElementById('energyLevel').value = progress.energyLevel;
                    }

                    updateDisplay();

                    // Show summary of loaded weeks
                    const weekCount = Object.keys(weeklyHistory).length;
                    if (weekCount > 0) {
                        addChatMessage('ai', `üìö ${weekCount} semana(s) carregada(s) do hist√≥rico! Use "üìö Hist√≥rico" para navegar entre elas.`);
                    }
                } catch (e) {
                    console.error('Erro ao carregar progresso:', e);
                }
            } else {
                // First time - show welcome message
                addChatMessage('ai', 'Oi! Agora voc√™ pode navegar entre semanas e todas ficam salvas automaticamente! Use o bot√£o "üìö Hist√≥rico" para ver todas as suas semanas. üòä');
            }
        }

        function regenerateSchedule() {
            const weeklyFocus = document.getElementById('weeklyFocus').value;
            const energyLevel = document.getElementById('energyLevel').value;

            const focusTemplate = scheduleTemplates[weeklyFocus];
            const energyConfig = energyAdjustments[energyLevel];

            // Clear current tasks and regenerate
            allTasks = [];
            loadDefaultSchedule();
            updateAllViews(); // Force update all views

            // Add chat message about the change
            const message = `üîÑ Agenda regenerada! Foco: ${focusTemplate.name} | Energia: ${energyConfig.name}. Academia ${energyConfig.academyFreq}x/semana, Projeto S√°fico ${energyConfig.projectTime}h/dia.`;
            addChatMessage('ai', message);

            showNotification('Agenda Atualizada!', `Foco: ${focusTemplate.name} | ${energyConfig.name}`, 'success');
            saveProgress();
        }

        function startNewWeeklyRoutine() {
            // Get current settings
            const currentDate = document.getElementById('currentDate').value;
            const weeklyFocus = document.getElementById('weeklyFocus').value;
            const energyLevel = document.getElementById('energyLevel').value;

            const focusTemplate = scheduleTemplates[weeklyFocus];
            const energyConfig = energyAdjustments[energyLevel];

            // Confirmation with current settings
            const confirmMessage = `üöÄ INICIAR NOVA ROTINA SEMANAL?\n\n` +
                `üìÖ Data: ${new Date(currentDate).toLocaleDateString('pt-BR')}\n` +
                `üéØ Foco: ${focusTemplate.name}\n` +
                `‚ö° Energia: ${energyConfig.name}\n\n` +
                `üìã Isso vai:\n` +
                `‚Ä¢ Academia ${energyConfig.academyFreq}x por semana\n` +
                `‚Ä¢ Projeto S√°fico ${energyConfig.projectTime}h por dia\n` +
                `‚Ä¢ Priorizar: ${focusTemplate.mainTasks[0]}\n` +
                `‚Ä¢ Regenerar toda agenda baseada nessas configura√ß√µes\n\n` +
                `Confirma?`;

            if (confirm(confirmMessage)) {
                // Clear everything and start fresh
                allTasks = [];
                chatHistory = [];

                // Set the current date from input
                window.currentDate = new Date(currentDate);

                // Generate completely new schedule based on current settings
                const newSchedule = generateSmartSchedule();
                const startOfWeek = getStartOfWeek(window.currentDate);
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

                // Populate tasks for the week
                dayNames.forEach((dayName, index) => {
                    const dayDate = new Date(startOfWeek.getTime() + (index * 24 * 60 * 60 * 1000)); // More reliable calculation

                    console.log(`Creating ${dayName} for ${dayDate.toDateString()}`); // Debug log

                    if (newSchedule[dayName]) {
                        newSchedule[dayName].forEach(task => {
                            allTasks.push({
                                id: generateId(),
                                date: formatDate(dayDate),
                                ...task
                            });
                        });
                    }
                });

                // Update display
                updateDisplay();

                // Add success message to chat
                const successMessage = `üöÄ ROTINA INICIADA COM SUCESSO!\n\n` +
                    `‚úÖ Agenda regenerada para ${focusTemplate.name}\n` +
                    `‚úÖ Configurada para ${energyConfig.name}\n` +
                    `‚úÖ Academia programada ${energyConfig.academyFreq}x na semana\n` +
                    `‚úÖ Projeto S√°fico: ${energyConfig.projectTime}h di√°rias\n` +
                    `‚úÖ Foco principal: ${focusTemplate.mainTasks[0]}\n\n` +
                    `Sua semana est√° organizada! Clique em qualquer tarefa para personalizar. üí™`;

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">üöÄ</div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 shadow-sm max-w-md">
                            <p class="text-sm font-medium text-green-800">ROTINA INICIADA!</p>
                            <p class="text-xs text-green-700 mt-1">${successMessage}</p>
                        </div>
                    </div>
                `;

                // Show notification
                showNotification('üöÄ ROTINA INICIADA!', `${focusTemplate.name} | ${energyConfig.name}`, 'success');

                // Save progress
                saveProgress();

                // Auto-scroll to show the new schedule
                setTimeout(() => {
                    document.getElementById('scheduleContainer').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 500);
            }
        }

        function resetWeeklyProgress() {
            if (confirm('üîÑ Deseja resetar toda a agenda e come√ßar uma nova semana?')) {
                localStorage.removeItem('dynamicPlannerProgress');
                allTasks = [];
                chatHistory = [];
                currentDate = new Date();
                document.getElementById('currentDate').valueAsDate = currentDate;

                loadDefaultSchedule();
                updateDisplay();

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="bg-indigo-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">AI</div>
                        <div class="bg-white rounded-lg p-3 shadow-sm max-w-md">
                            <p class="text-sm">üîÑ Nova semana iniciada! Sua agenda foi regenerada com base no seu foco e energia atuais. Agora voc√™ pode editar qualquer tarefa clicando nela!</p>
                        </div>
                    </div>
                `;

                showNotification('Agenda Resetada!', 'Nova semana iniciada com sucesso', 'success');
            }
        }

        function showWeekHistory() {
            const modal = document.getElementById('weekHistoryModal');
            const historyList = document.getElementById('weekHistoryList');

            // Sort weeks by date (newest first)
            const sortedWeeks = Object.keys(weeklyHistory).sort((a, b) => {
                const [yearA, weekA] = a.split('-W').map(Number);
                const [yearB, weekB] = b.split('-W').map(Number);
                return yearB - yearA || weekB - weekA;
            });

            historyList.innerHTML = '';

            if (sortedWeeks.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìÖ</div>
                        <p>Nenhuma semana salva ainda</p>
                        <p class="text-sm">Navegue entre semanas para criar seu hist√≥rico</p>
                    </div>
                `;
            } else {
                sortedWeeks.forEach(weekKey => {
                    const week = weeklyHistory[weekKey];
                    const isCurrentWeek = weekKey === currentWeekKey;

                    const weekItem = document.createElement('div');
                    weekItem.className = `border rounded-lg p-4 ${isCurrentWeek ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300'} transition-colors`;

                    const created = new Date(week.created).toLocaleDateString('pt-BR');
                    const modified = new Date(week.lastModified).toLocaleDateString('pt-BR');

                    weekItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-semibold text-gray-900">${weekKey}</h4>
                                    ${isCurrentWeek ? '<span class="bg-indigo-500 text-white px-2 py-1 rounded-full text-xs">Atual</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <div>üìã ${week.tasks.length} tarefas</div>
                                    <div>üéØ ${week.settings?.weeklyFocus ? scheduleTemplates[week.settings.weeklyFocus]?.name : 'N/A'}</div>
                                    <div>‚ö° ${week.settings?.energyLevel ? energyAdjustments[week.settings.energyLevel]?.name : 'N/A'}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Criada: ${created} | Modificada: ${modified}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                ${!isCurrentWeek ? `<button onclick="switchToWeek('${weekKey}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">üìÖ Abrir</button>` : ''}
                                <button onclick="duplicateWeek('${weekKey}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors">üìã Duplicar</button>
                                <button onclick="deleteWeek('${weekKey}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;

                    historyList.appendChild(weekItem);
                });
            }

            modal.classList.remove('hidden');
        }

        function closeWeekHistory() {
            document.getElementById('weekHistoryModal').classList.add('hidden');
        }

        function createNewWeek() {
            const nextWeekDate = new Date(currentDate);
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);

            const nextWeekKey = getWeekKey(nextWeekDate);

            if (weeklyHistory[nextWeekKey]) {
                alert(`Semana ${nextWeekKey} j√° existe! Use "Abrir" para acess√°-la.`);
                return;
            }

            // Save current week first
            saveCurrentWeek();

            // Switch to new week
            currentDate = nextWeekDate;
            document.getElementById('currentDate').valueAsDate = currentDate;

            allTasks = [];
            loadDefaultSchedule();
            updateAllViews();

            closeWeekHistory();
            addChatMessage('ai', `üÜï Nova semana ${nextWeekKey} criada! Agenda gerada com base nas suas configura√ß√µes atuais.`);
        }

        function duplicateCurrentWeek() {
            const nextWeekDate = new Date(currentDate);
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);
            const nextWeekKey = getWeekKey(nextWeekDate);

            duplicateWeek(currentWeekKey, nextWeekKey);
        }

        function duplicateWeek(sourceWeekKey, targetWeekKey = null) {
            if (!weeklyHistory[sourceWeekKey]) {
                alert('Semana fonte n√£o encontrada!');
                return;
            }

            if (!targetWeekKey) {
                // Find next available week
                const [year, week] = sourceWeekKey.split('-W').map(Number);
                targetWeekKey = `${year}-W${(week + 1).toString().padStart(2, '0')}`;

                // If it's the last week of the year, go to next year
                if (week >= 52) {
                    targetWeekKey = `${year + 1}-W01`;
                }
            }

            if (weeklyHistory[targetWeekKey]) {
                if (!confirm(`Semana ${targetWeekKey} j√° existe. Substituir?`)) {
                    return;
                }
            }

            const sourceWeek = weeklyHistory[sourceWeekKey];

            // Calculate date offset
            const [sourceYear, sourceWeekNum] = sourceWeekKey.split('-W').map(Number);
            const [targetYear, targetWeekNum] = targetWeekKey.split('-W').map(Number);

            const sourceDate = new Date(sourceYear, 0, 1 + (sourceWeekNum - 1) * 7);
            const targetDate = new Date(targetYear, 0, 1 + (targetWeekNum - 1) * 7);
            const daysDiff = Math.floor((targetDate - sourceDate) / (24 * 60 * 60 * 1000));

            // Duplicate tasks with new dates
            const newTasks = sourceWeek.tasks.map(task => {
                const taskDate = new Date(task.date);
                taskDate.setDate(taskDate.getDate() + daysDiff);

                return {
                    ...task,
                    id: generateId(),
                    date: formatDate(taskDate)
                };
            });

            // Create new week
            weeklyHistory[targetWeekKey] = {
                tasks: newTasks,
                settings: { ...sourceWeek.settings },
                created: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            saveProgress();
            showWeekHistory(); // Refresh the modal

            addChatMessage('ai', `üìã Semana ${sourceWeekKey} duplicada para ${targetWeekKey}! ${newTasks.length} tarefas copiadas.`);
        }

        function deleteWeek(weekKey) {
            if (weekKey === currentWeekKey) {
                alert('N√£o √© poss√≠vel excluir a semana atual!');
                return;
            }

            if (!confirm(`Tem certeza que deseja excluir a semana ${weekKey}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }

            delete weeklyHistory[weekKey];
            saveProgress();
            showWeekHistory(); // Refresh the modal

            addChatMessage('ai', `üóëÔ∏è Semana ${weekKey} exclu√≠da do hist√≥rico.`);
        }

        function exportAllWeeks() {
            let exportText = `üìö HIST√ìRICO COMPLETO DE SEMANAS\n`;
            exportText += `üìÜ Exportado em: ${new Date().toLocaleString('pt-BR')}\n`;
            exportText += `üìä Total: ${Object.keys(weeklyHistory).length} semanas\n\n`;

            if (Object.keys(weeklyHistory).length === 0) {
                exportText += `‚ö†Ô∏è Nenhuma semana encontrada no hist√≥rico.\n\n`;
                exportText += `ü§ñ Gerado pelo Planejador Din√¢mico`;
                showExportModal(exportText);
                return;
            }

            // Sort weeks chronologically
            const sortedWeeks = Object.keys(weeklyHistory).sort((a, b) => {
                const [yearA, weekA] = a.split('-W').map(Number);
                const [yearB, weekB] = b.split('-W').map(Number);
                return yearA - yearB || weekA - weekB;
            });

            sortedWeeks.forEach(weekKey => {
                const week = weeklyHistory[weekKey];
                const created = new Date(week.created).toLocaleDateString('pt-BR');

                exportText += `üìÖ SEMANA ${weekKey}\n`;
                exportText += `üéØ Foco: ${week.settings?.weeklyFocus ? scheduleTemplates[week.settings.weeklyFocus]?.name : 'N/A'}\n`;
                exportText += `‚ö° Energia: ${week.settings?.energyLevel ? energyAdjustments[week.settings.energyLevel]?.name : 'N/A'}\n`;
                exportText += `üìã Tarefas: ${week.tasks.length} | Criada: ${created}\n\n`;

                // Group tasks by date
                const tasksByDate = {};
                week.tasks.forEach(task => {
                    if (!tasksByDate[task.date]) {
                        tasksByDate[task.date] = [];
                    }
                    tasksByDate[task.date].push(task);
                });

                Object.keys(tasksByDate).sort().forEach(date => {
                    const dateObj = new Date(date);
                    const dayName = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                    exportText += `  üìÖ ${dayName.toUpperCase()} - ${dateObj.toLocaleDateString('pt-BR')}\n`;

                    tasksByDate[date].sort((a, b) => a.time.localeCompare(b.time)).forEach(task => {
                        exportText += `    ${task.time} - ${task.task}\n`;
                    });
                    exportText += `\n`;
                });

                exportText += `${'='.repeat(50)}\n\n`;
            });

            exportText += `ü§ñ Gerado pelo Planejador Din√¢mico`;
            showExportModal(exportText);
        }

        // Initialize the application
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e46ab574e63652',t:'MTc1NTA0ODMwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
